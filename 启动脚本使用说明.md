# 启动脚本使用说明

## 📋 脚本功能

`start.sh` 是一个智能启动脚本，具有以下功能：

### ✅ 核心功能
1. **端口检查**：启动前自动检查端口8001（后端）和8091（前端）是否被占用
2. **进程清理**：如果端口被占用，自动查找并杀掉占用进程
3. **依赖检查**：自动检查并安装缺失的依赖（Python包和Node.js包）
4. **数据库初始化**：自动检查并初始化SQLite数据库
5. **启动监控**：监控服务启动状态，确保服务正常启动
6. **错误修复**：根据错误信息自动修复常见问题

### 🔧 自动修复功能

脚本能够自动修复以下常见错误：

1. **依赖缺失**
   - Python包缺失 → 自动运行 `pip install -r requirements.txt`
   - Node.js包缺失 → 自动运行 `npm install` 或 `pnpm install`

2. **端口占用**
   - 自动查找占用端口的进程
   - 自动杀掉占用进程
   - 支持多种方法：lsof、netstat、ss、fuser

3. **数据库问题**
   - 数据库不存在 → 自动初始化数据库
   - 数据库连接失败 → 尝试重新初始化

4. **虚拟环境**
   - 虚拟环境不存在 → 自动创建虚拟环境

## 🚀 使用方法

### 基本用法

```bash
# 进入项目目录
cd /data/mjg

# 启动服务（默认）
./start.sh
# 或
./start.sh start

# 查看服务状态
./start.sh status

# 停止服务
./start.sh stop

# 重启服务
./start.sh restart
```

## 📊 启动流程

1. **检查环境**
   - 检查Python虚拟环境
   - 检查Node.js环境
   - 检查依赖包

2. **清理端口**
   - 检查后端端口（8001）
   - 检查前端端口（8091）
   - 如果被占用，自动清理

3. **启动后端**
   - 激活虚拟环境
   - 启动uvicorn服务器
   - 监控启动状态（最多等待30秒）
   - 验证API可访问性

4. **启动前端**
   - 检查Node.js依赖
   - 启动Rspack开发服务器
   - 监控启动状态（最多等待30秒）
   - 验证前端可访问性

5. **显示状态**
   - 显示服务运行状态
   - 显示访问地址
   - 显示日志文件位置

## 📝 日志文件

- **后端日志**: `/tmp/mjg_backend.log`
- **前端日志**: `/tmp/mjg_frontend.log`
- **进程ID文件**: 
  - `/tmp/mjg_backend.pid`
  - `/tmp/mjg_frontend.pid`

## 🔍 查看日志

```bash
# 实时查看后端日志
tail -f /tmp/mjg_backend.log

# 实时查看前端日志
tail -f /tmp/mjg_frontend.log

# 查看最后20行后端日志
tail -20 /tmp/mjg_backend.log

# 查看最后30行前端日志
tail -30 /tmp/mjg_frontend.log
```

## ⚠️ 注意事项

1. **权限问题**
   - 确保脚本有执行权限：`chmod +x start.sh`
   - 如果端口清理失败，可能需要root权限

2. **端口占用**
   - 如果自动清理失败，可以手动清理：
     ```bash
     # 查找占用端口的进程
     lsof -i :8001
     lsof -i :8091
     
     # 杀掉进程
     kill -9 <PID>
     ```

3. **依赖安装**
   - 首次运行可能需要较长时间安装依赖
   - 确保网络连接正常

4. **数据库**
   - 数据库文件位于：`/data/mjg/backend/database.db`
   - 首次运行会自动创建

## 🎯 故障排查

### 问题1：端口清理失败

**解决方案**：
```bash
# 手动查找并清理
sudo lsof -i :8001
sudo kill -9 <PID>

sudo lsof -i :8091
sudo kill -9 <PID>
```

### 问题2：依赖安装失败

**解决方案**：
```bash
# 后端依赖
cd /data/mjg/backend
source venv/bin/activate
pip install -r requirements.txt

# 前端依赖
cd /data/mjg/vue3-admin-better
npm install
```

### 问题3：服务启动超时

**解决方案**：
1. 检查日志文件查看具体错误
2. 检查端口是否真的被占用
3. 检查防火墙设置
4. 尝试手动启动服务查看错误信息

### 问题4：数据库初始化失败

**解决方案**：
```bash
cd /data/mjg/backend
source venv/bin/activate
python -c "from app.db.init_db import init_db; init_db()"
```

## 📞 技术支持

如果遇到问题：
1. 查看日志文件获取详细错误信息
2. 检查服务状态：`./start.sh status`
3. 尝试手动启动服务查看错误
4. 检查系统资源（内存、磁盘空间）

## 🎉 成功启动标志

启动成功后，你会看到：

```
[SUCCESS] 后端启动成功！
[SUCCESS] 前端启动成功！

========== 服务状态 ==========
[SUCCESS] 后端服务运行中 (端口 8001)
  API文档: http://localhost:8001/docs
  API地址: http://localhost:8001
[SUCCESS] 前端服务运行中 (端口 8091)
  访问地址: http://localhost:8091

[SUCCESS] 所有服务启动成功！
```

然后就可以在浏览器中访问：
- 前端应用：http://localhost:8091
- API文档：http://localhost:8001/docs


















